# Настройка автоматической оплаты через YooKassa

## Что было сделано:

1. ✅ Интегрирован платежный сервис YooKassa
2. ✅ Настроена автоматическая обработка оплаты через webhook
3. ✅ Реализована автоматическая отправка чека и билета на email после оплаты
4. ✅ Установлена цена всех билетов на 10 рублей для тестирования

## Настройка YooKassa:

### 1. Получите данные для подключения:

1. Зарегистрируйтесь в [YooKassa](https://yookassa.ru/)
2. Перейдите в раздел "Настройки" → "API"
3. Скопируйте:
   - **Shop ID** (идентификатор магазина)
   - **Секретный ключ** (Secret Key)

### 2. Настройте переменные окружения:

Добавьте в файл `.env`:

```env
YOOKASSA_SHOP_ID=ваш_shop_id
YOOKASSA_SECRET_KEY=ваш_секретный_ключ
YOOKASSA_TEST_MODE=true
USE_YOOKASSA=true
```

### 3. Настройте webhook для автоматической обработки оплаты:

1. Войдите в личный кабинет YooKassa: https://yookassa.ru/my
2. Перейдите в раздел "Настройки" → "Уведомления"
3. Добавьте URL для webhook:
   ```
   https://ваш-домен.ru/payment/webhook
   ```
   Или для локальной разработки (используя ngrok или подобный сервис):
   ```
   https://ваш-ngrok-домен.ngrok.io/payment/webhook
   ```

4. Выберите события для уведомлений:
   - ✅ `payment.succeeded` - успешная оплата
   - ✅ `payment.canceled` - отмена оплаты

### 4. Настройте отправку email:

Добавьте в файл `.env` настройки для отправки email:

```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=ваш_email@gmail.com
MAIL_PASSWORD=ваш_пароль_приложения
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=ваш_email@gmail.com
MAIL_FROM_NAME="EventGo"
```

**Для Gmail:**
- Используйте пароль приложения, а не обычный пароль
- Создайте пароль приложения: https://myaccount.google.com/apppasswords

**Для других почтовых сервисов:**
- Yandex: `smtp.yandex.ru`, порт 465 (SSL) или 587 (TLS)
- Mail.ru: `smtp.mail.ru`, порт 465 (SSL) или 587 (TLS)

## Как это работает:

1. **Создание заказа:**
   - Пользователь создает заказ на сайте
   - Система автоматически создает платеж в YooKassa
   - Пользователь перенаправляется на страницу оплаты YooKassa

2. **Оплата:**
   - Пользователь оплачивает заказ на странице YooKassa
   - YooKassa отправляет webhook на ваш сервер

3. **Автоматическая обработка:**
   - Webhook автоматически обрабатывается
   - Статус заказа обновляется на "оплачен"
   - Автоматически генерируется чек и билет
   - Чек и билет автоматически отправляются на email покупателя

## Тестирование:

### Тестовый режим YooKassa:

1. Используйте тестовые данные карт:
   - **Успешная оплата:** `5555555555554444` (любая дата, любой CVV)
   - **Отклоненная оплата:** `5555555555554477`

2. Для тестирования webhook локально используйте:
   - [ngrok](https://ngrok.com/) для создания туннеля
   - Или используйте тестовый эндпоинт: `POST /payment/test-check/{order_id}`

### Проверка работы:

1. Создайте тестовый заказ
2. Перейдите на страницу оплаты
3. Вы будете перенаправлены на YooKassa
4. Оплатите тестовой картой
5. После оплаты автоматически придет:
   - Чек на email
   - Билет на email

## Важные замечания:

- ⚠️ Все билеты установлены на цену **10 рублей** для тестирования
- ⚠️ Убедитесь, что webhook URL доступен из интернета
- ⚠️ Проверьте настройки email перед продакшеном
- ⚠️ В тестовом режиме YooKassa не списывает реальные деньги

## Команды для управления:

```bash
# Установить цену всех билетов на 10 рублей
php artisan tickets:set-price 10

# Установить другую цену
php artisan tickets:set-price 1000
```

## Логирование:

Все операции логируются в файл `storage/logs/laravel.log`:
- Создание платежей
- Обработка webhook
- Отправка email
- Ошибки

## Поддержка:

При возникновении проблем проверьте:
1. Логи: `storage/logs/laravel.log`
2. Настройки в `.env`
3. Доступность webhook URL
4. Настройки email

